<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white h-screen flex">
{% csrf_token %}


<aside class="w-72 bg-gray-800 border-r border-gray-700 flex flex-col">
    <div class="p-4 flex items-center justify-between">
      <h2 class="font-semibold">Chats</h2>
      <a href="{% url 'chat:new' %}"
         class="text-sm bg-blue-600 px-3 py-2 rounded-lg hover:bg-blue-700">
        + New
      </a>
    </div>

    <div class="px-4 pb-2 text-xs text-gray-400">
      Logged in as <span class="text-gray-200">{{ request.user.username }}</span>
    </div>


    <nav class="flex-1 overflow-y-auto px-2 space-y-1">
      {% for c in conversations %}
        <a href="{% url 'chat:detail' c.id %}"
           class="block px-3 py-2 rounded-lg hover:bg-gray-700
                  {% if c.id == conversation.id %} bg-gray-700 {% endif %}">
          <div class="text-sm font-medium truncate">{{ c.title }}</div>
          <div class="text-xs text-gray-400">
            {{ c.updated_at|date:"M d, H:i" }}
          </div>
        </a>
      {% empty %}
        <p class="text-gray-400 text-sm px-3 py-2">No conversations yet.</p>
      {% endfor %}
    </nav>


   <form method="post" action="{% url 'chat:logout' %}">
  {% csrf_token %}
  <button type="submit"
          class="w-full text-center bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg">
    Logout
  </button>
</form>
  </aside>

<main class="flex-1 flex flex-col">
    <header class="bg-gray-800 p-4 border-b border-gray-700">
      <h1 class="text-lg font-semibold truncate">{{ conversation.title }}</h1>
    </header>
    <div id="chat-container" class="flex-1 overflow-y-auto p-6 space-y-4">

        {% for msg in messages %}
        {% if msg.is_bot %}
         <div class="flex">
            <div class="bg-gray-700 p-3 rounded-2xl max-w-lg">
               {{msg.content}}
            </div>
        </div>
        {% else %}
        <div class="flex justify-end">
                    <div class="bg-blue-600 p-3 rounded-2xl max-w-lg">
                        {{msg.content}}
                    </div>
                </div>
        {% endif %}
        {% endfor %}
    </div>


    <div class="bg-gray-800 p-4">
        <div class="flex space-x-3">
            <input
                id="message-input"
                type="text"
                name="message"
                placeholder="Type your message..."
                class="flex-1 p-3 rounded-xl bg-gray-700 text-white focus:outline-none"
            >
            <button
                onclick="sendMessage()"
                class="bg-blue-600 px-5 py-3 rounded-xl hover:bg-blue-700 transition"
            >
                Send
            </button>
        </div>
    </div>
 </main>
<script>
const scheme = window.location.protocol === "https:" ? "wss" : "ws";
const socket = new WebSocket(`${scheme}://${window.location.host}/ws/chat/`);

let currentBotDiv = null;

socket.onopen = () => console.log("socket open âœ…");

socket.onmessage = (e) => {
  const data = JSON.parse(e.data);
  const chat = document.getElementById("chat-container");

  if (data.type === "title") {
  document.querySelector("header h1").textContent = data.text;
}

  if (data.type === "start") {
    // create empty bot bubble
    const wrapper = document.createElement("div");
    wrapper.className = "flex";

    wrapper.innerHTML = `
      <div class="bg-gray-700 p-3 rounded-2xl max-w-lg"></div>
    `;

    chat.appendChild(wrapper);
    currentBotDiv = wrapper.querySelector("div");
  }

  if (data.type === "delta" && currentBotDiv) {
    currentBotDiv.textContent += data.text;
    chat.scrollTop = chat.scrollHeight;
  }

  if (data.type === "done") {
    currentBotDiv = null;
  }

  if (data.type === "error") {
    alert(data.text);
    currentBotDiv = null;
  }
};

socket.onerror = (e) => console.log("WebSocket error", e);
socket.onclose = () => console.log("WebSocket closed");

function sendMessage() {
  const input = document.getElementById("message-input");
  const message = input.value.trim();
  if (!message) return;

  const chat = document.getElementById("chat-container");

  // show user bubble immediately
  chat.insertAdjacentHTML("beforeend", `
    <div class="flex justify-end">
      <div class="bg-blue-600 p-3 rounded-2xl max-w-lg">${message}</div>
    </div>
  `);

  socket.send(JSON.stringify({
  message,
  conversation_id: {{ conversation.id }}
}));
  input.value = "";
  chat.scrollTop = chat.scrollHeight;
}
</script>

<!--    <script>-->
<!--        function sendMessage() {-->
<!--            const input = document.getElementById("message-input");-->
<!--            const message = input.value.trim();-->
<!--            if (!message) return;-->

<!--            const chatContainer = document.getElementById("chat-container");-->

<!--            // Add user message-->
<!--            chatContainer.innerHTML += `-->
<!--                <div class="flex justify-end">-->
<!--                    <div class="bg-blue-600 p-3 rounded-2xl max-w-lg">-->
<!--                        ${message}-->
<!--                    </div>-->
<!--                </div>-->
<!--            `;-->

<!--            // Clear input-->
<!--            input.value = "";-->

<!--            // Send to Django backend-->
<!--            fetch("", {-->
<!--                method: "POST",-->
<!--                headers: {-->
<!--                    "Content-Type": "application/x-www-form-urlencoded",-->
<!--                    "X-CSRFToken": "{{ csrf_token }}"-->
<!--                },-->
<!--                body: "message=" + encodeURIComponent(message)-->
<!--            })-->
<!--            .then(response => response.json())-->
<!--            .then(data => {-->
<!--                chatContainer.innerHTML += `-->
<!--                    <div class="flex">-->
<!--                        <div class="bg-gray-700 p-3 rounded-2xl max-w-lg">-->
<!--                            ${data.response}-->
<!--                        </div>-->
<!--                    </div>-->
<!--                `;-->
<!--                chatContainer.scrollTop = chatContainer.scrollHeight;-->
<!--            });-->
<!--        }-->
<!--    </script>-->

</body>
</html>